<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EaglerFabric Launcher</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="header">EaglerFabric Launcher</div>

<div id="container">
    <div id="sidebar">
        <h2>ModMenu</h2>
        <label for="modUpload">Upload Mod Folders or ZIPs:</label>
        <input type="file" id="modUpload" multiple webkitdirectory directory>
        <div id="modListContainer">
            <ul id="modList"></ul>
        </div>
        <button id="playBtn">Play</button>
        <button id="downloadBtn">Download Launcher with Mods</button>
        <div id="status"></div>
    </div>

    <iframe id="gameFrame" src="eagler-client/Eaglercraft_1.12_Offline_en_US.html" style="border:none; width:100%; height:100vh;"></iframe>
</div>

<script src="libs/jszip.min.js"></script>
<script src="api/api.js"></script>
<script src="mod-system/utils.js"></script>
<script src="mod-system/loader.js"></script>

<script>
const modUpload = document.getElementById("modUpload");
const modListUL = document.getElementById("modList");
const status = document.getElementById("status");
const iframe = document.getElementById("gameFrame");

modUpload.addEventListener("change", async (event) => {
    status.textContent = "Processing mods...";
    modListUL.innerHTML = "";
    const inputFiles = Array.from(event.target.files);
    const fileList = await LoaderUtils.getFilesFromDirectoryInput(modUpload);

    for (const file of fileList) {
        if (file.name.endsWith(".zip")) {
            const extracted = await LoaderUtils.extractZipFiles(file);
            fileList.push(...extracted);
        }
    }

    const modsMap = {};
    fileList.forEach(f => {
        const path = f.webkitRelativePath || f.name;
        const top = path.split("/")[0];
        if (!modsMap[top]) modsMap[top] = [];
        modsMap[top].push(f);
    });

    for (const modName in modsMap) {
        const modFiles = modsMap[modName];
        const mod = await EaglerLoader.loadModFolder(modFiles, iframe);
        const li = document.createElement("li");
        li.textContent = modName;
        li.className = "mod-entry";
        modListUL.appendChild(li);
    }

    status.textContent = `Loaded ${Object.keys(modsMap).length} mod(s).`;
});

document.getElementById("playBtn").addEventListener("click", () => {
    status.textContent = "Launching EaglerFabric client...";
    if (window.EaglerAPI && typeof window.EaglerAPI.init === "function") {
        window.EaglerAPI.init();
    }
    EaglerLoader.EAGLER_MODS.forEach(m => console.log("Mod loaded:", m.id));
    status.textContent = "Game launched!";
});

// Download button logic
document.getElementById("downloadBtn").addEventListener("click", async () => {
    if (!EaglerLoader.EAGLER_MODS.length) {
        alert("No mods loaded to include!");
        return;
    }
    const zip = new JSZip();
    // Add Eagler-client launcher HTML
    const clientHtmlResp = await fetch("eagler-client/Eaglercraft_1.12_Offline_en_US.html");
    const clientHtml = await clientHtmlResp.text();
    zip.file("eagler-client/Eaglercraft_1.12_Offline_en_US.html", clientHtml);

    // (Optional) TODO: recursively include wasm/ and assets/ â€” implement as needed

    const modsFolder = zip.folder("mods");
    EaglerLoader.EAGLER_MODS.forEach(mod => {
        const folder = modsFolder.folder(mod.id);
        mod.files.forEach(f => {
            folder.file(f.path.split("/").slice(1).join("/"), f.content);
        });
    });

    const launcherHtml = await fetch("index.html").then(r => r.text());
    zip.file("index.html", launcherHtml);

    const blob = await zip.generateAsync({ type: "blob" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "EaglerFabric_Launcher_With_Mods.zip";
    a.click();
});
</script>
</body>
</html>
